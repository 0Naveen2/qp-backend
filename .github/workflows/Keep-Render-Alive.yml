# .github/workflows/api-test.yml

name: 'Login and Test Departments Endpoint every 5 minutes'

on:
  schedule:
    - cron: '*/5 * * * *'
  push:
    branches: [ main ]

jobs:
  login-and-call-api:
    runs-on: ubuntu-latest
    steps:
      - name: Log in and get access token
        id: login
        run: |
          # <-- CHANGED: Using the new secret for the URL
          response=$(curl -s -X POST '${{ secrets.BACKEND_URL }}/auth/login' \
          -H 'Content-Type: application/json' \
          -d '{"username": "${{ secrets.API_USERNAME }}", "password": "${{ secrets.API_PASSWORD }}"}')
          
          token=$(echo "$response" | jq -r '.token')
          echo "jwt=${token}" >> $GITHUB_OUTPUT

      - name: Get all departments
        run: |
          echo "Using token to fetch departments..."
          # <-- CHANGED: Using the new secret for the URL here too
          curl -f -X GET '${{ secrets.BACKEND_URL }}/departments' \
          -H 'Authorization: Bearer ${{ steps.login.outputs.jwt }}'
